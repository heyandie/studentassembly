<template lang="jade">
v-header
section.page__wrapper
  .content__wrapper
    .content__section
      h1 File a report
      article.content__main
        .form__wrapper
          form(action="/api/report" method="post" enctype="multipart/form-data")
            .form__element
              .form__label School
              .form__select
                select(name="school" v-model="request.report.school" number)
                  option(disabled selected hidden value="0") Choose a school...
                  option(v-for="school in schools" value="{{ school.id }}") {{ school.name }}
            .form__element
              .form__label Type of Report
              .form__select
                select(name="category" v-model="request.report.category" number)
                  option(disabled selected hidden value="0") Choose a category..
                  option(v-for="category in categories" value="{{ category.id }}") {{ category.name }}
            .form__element
              .form__label Report Details
              textarea(rows="6" name="text" placeholder="State the corruption case in detail." v-model="request.report.text")
            .form__element
              .form__label Attachments
              .form__note It can either be an image or a document. Each file has a 3MB limit.
              .form__attachments
                .form__attachment
                  input(type="file" id="file1" accept="image/*" name="files[]" v-on:change="checkFile($event, 0)")
                  label(for="file1") {{ request.report.files[0] | fileName }}
                .form__attachment
                  input(type="file" id="file2" accept="image/*" name="files[]" v-on:change="checkFile($event, 1)" v-bind:disabled="request.report.files[0] === null")
                  label(for="file2") {{ request.report.files[1] | fileName }}
                .form__attachment
                  input(type="file" id="file3" accept="image/*" name="files[]" v-on:change="checkFile($event, 2)" v-bind:disabled="request.report.files[1] === null")
                  label(for="file3") {{ request.report.files[2] | fileName }}
            .form__element
              .form__label Do you want to publish your report?
              .form__note
                span Agreeing to publish your report does not guarantee its posting. Student Assembly reserves the right to not publish reports that may be damaging / harmful to others.
                span &nbsp;Your post will be anonymously posted as [username].
              .form__radio
                input(type="radio" name="allow_publish" id="allow_publish_1" value="1" v-model="request.report.allow_publish" number)
                label(for="allow_publish_1") Yes, publish my report.
              .form__radio
                input(type="radio" name="allow_publish" id="allow_publish_2" value="0" checked v-model="request.report.allow_publish" number)
                label(for="allow_publish_2") No, don't publish my report.
            .form__element
              .form__label Are you willing to provide your contact details?
              .form__note If this is a sexual harassment or discrimination report and you would like to pursue legal action, kindly give your contact information.
              .form__radio
                input(type="radio" name="allow_contact" id="allow_contact_1" value="1" v-model="request.contact.allow_contact" number)
                label(for="allow_contact_1") Yes, I would to give my contact.
              .form__radio
                input(type="radio" name="allow_contact" id="allow_contact_2" value="0" checked v-model="request.contact.allow_contact" number)
                label(for="allow_contact_2") No, I don't want to give my contact.
              template(v-if="request.contact.allow_contact === 1")
                input(type="text" name="name" placeholder="Name" v-model="request.contact.name")
                input(type="text" name="mobile_number" placeholder="Mobile Number" v-model="request.contact.mobile_number")
            .form__element
              button(type="submit" @click.prevent="submitReport" v-bind:disabled="loading")
                span(v-show="!loading") Submit
                .button__spinner(v-show="loading")
                  v-spinner(color="#fff" height="6px" width="3px" radius="8px")

      aside.content__secondary.content--additional-info
        h4
          img(src="/static/img/icons/action/ic_lightbulb_outline_24px.svg" height="18")
          span Some Tips
        ul
          li
            p.small Put the appropriate category so we can place your report properly.
          li
            p.small By entering more relevant details in your report, you are increasing the chances of action being taken:
            ul
              li
                p.small Name and designation of the people responsible
              li
                 p.small Date, time, and location of the incident


v-footer
</template>

<script>
var Header = require('../components/header.vue');
var Footer = require('../components/footer.vue');
var Spinner = require('../components/spinner.vue');

module.exports = {
  data: function() {
    return {
      schools: null,
      categories: null,
      loading: false,
      request: {
        contact: {
          allow_contact: false,
          name: null,
          contact_number: null
        },
        report: {
          category: null,
          school: null,
          text: null,
          answers: null,
          files: [null, null, null],
          allow_publish: false
        }
      }

    }
  },
  filters: {
    fileName: function(file) {
      if (file !== null)
        return file.name;
    }
  },
  methods: {
    checkFile: function(event, ind) {
      var file = event.target.files[0] || event.dataTransfer.files[0];

      this.$set('request.report.files[' + ind + ']', file);
      // this.request.report.files[ind] = file;
      console.log(this.request.report.files);
      // this.files[ind] = file;
      // this.fileNames[ind] = event.target.value.split('\\').pop();
    },
    submitReport: function() {
      var that = this;
      that.loading = true;
      client({ path: 'report', entity: this.request }).then(
        function (response) {
          console.log('accepted', response);
          that.loading = false;
        },
        function (response) {
          console.log('rejected', response);
          that.loading = false;
        }
      );
    }
  },
  ready: function() {
    var that = this;
    client({ path: 'schools' }).then(
      function (response) {
        that.schools = response.entity;
      },
      function (response) {
        console.log('Error trying to fetch schools. Contact the server again.');
      }
    );
    client({ path: 'categories' }).then(
      function (response) {
        that.categories = response.entity;
      },
      function (response) {
        console.log('Error trying to fetch categories. Contact the server again.');
      }
    );
  },
  components: {
    'v-header': Header,
    'v-footer': Footer,
    'v-spinner': Spinner
  }
}
</script>
